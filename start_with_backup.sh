#!/bin/bash

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$(date '+%H:%M:%S')] $1"
}

log "üöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º B2 –∫–ª—é—á–∏
if [ -z "$B2_KEY_ID" ] || [ -z "$B2_APPLICATION_KEY" ]; then
    log "‚ö†Ô∏è  –ë—ç–∫–∞–ø—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã (–Ω–µ—Ç –∫–ª—é—á–µ–π B2)"
    log "–ó–∞–ø—É—Å–∫–∞—é —Ç–æ–ª—å–∫–æ –±–æ—Ç–∞ –±–µ–∑ –±—ç–∫–∞–ø–æ–≤..."
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –±–æ—Ç–∞
    exec python bot.py
else
    log "‚úÖ –ë—ç–∫–∞–ø—ã –≤ B2 –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±—ç–∫–∞–ø-—Å–µ—Ä–≤–∏—Å –≤ –§–û–ù–û–í–û–ú —Ä–µ–∂–∏–º–µ (–±–µ–∑ &)
    log "üîÑ –ó–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã –±—ç–∫–∞–ø–æ–≤ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ..."
    nohup python hourly_backup.py > /tmp/backup.log 2>&1 &
    BACKUP_PID=$!
    log "üì¶ –°–ª—É–∂–±–∞ –±—ç–∫–∞–ø–æ–≤ –∑–∞–ø—É—â–µ–Ω–∞ (PID: $BACKUP_PID)"
    
    # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
    sleep 5
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–æ—Ç–∞ (foreground –ø—Ä–æ—Ü–µ—Å—Å)
    log "ü§ñ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞..."
    exec python bot.py
fi
